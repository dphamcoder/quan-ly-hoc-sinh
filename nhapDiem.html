<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nhập Điểm Bộ Môn - Hệ Thống Quản Lý</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="test.css">

    <style>
        /* === CSS RIÊNG CHO TRANG NHẬP ĐIỂM === */

        /* Thanh màu trên đầu các cột điểm (Giống thiết kế) */
        .header-hs1 { border-top: 5px solid #28a745 !important; } /* Xanh lá */
        .header-hs2 { border-top: 5px solid #dc3545 !important; } /* Đỏ */
        .header-hs3 { border-top: 5px solid #0d6efd !important; } /* Xanh dương */
        .header-dtb { border-top: 5px solid #ffc107 !important; } /* Vàng */

        /* Header Bảng */
        .grade-table th {
            text-align: center;
            vertical-align: middle;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            font-size: 14px;
        }

        /* Ô nhập điểm */
        .grade-input {
            width: 100%;
            height: 35px;
            text-align: center;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-weight: 600;
            color: #333;
            transition: all 0.2s;
        }
        .grade-input:focus {
            border-color: #4e73df;
            outline: none;
            box-shadow: 0 0 0 3px rgba(78, 115, 223, 0.1);
            background-color: #fff;
        }

        /* Ô ĐTB (Readonly) - Màu nền xám nhẹ */
        .avg-input {
            background-color: #e9ecef;
            border: 1px solid #ced4da;
            font-weight: 800;
            color: #4e73df;
            cursor: default;
        }

        /* Select box chọn lớp trên header */
        .header-select {
            border: none;
            background: transparent;
            font-size: 20px;
            font-weight: 800;
            color: #333;
            cursor: pointer;
            outline: none;
            padding: 5px;
            border-bottom: 2px solid transparent;
        }
        .header-select:hover { border-bottom-color: #333; }

        /* Nút lưu ở dưới cùng */
        .bottom-action-bar {
            margin-top: 20px;
            padding: 15px;
            background: #e9ecef;
            border: 1px solid #ccc;
            border-radius: 5px;
            text-align: center;
        }
        
        .btn-save-grades {
            padding: 10px 30px;
            background-color: #e2e6ea;
            border: 1px solid #333;
            color: #333;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: 0.2s;
        }
        .btn-save-grades:hover {
            background-color: #333;
            color: white;
        }
    </style>
</head>
<body class="admin-page">

    <div id="toast-container" style="position: fixed; top: 20px; right: 20px; z-index: 9999;"></div>

    <button id="toggleSidebar" class="toggle-btn" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <div class="container">
        
        <aside id="sidebar" class="sidebar">
            <div class="teacher-card">
                <div class="avatar"></div>
                <h3 id="userName">Đang tải...</h3> 
                <p id="userCode">...</p>
            </div>

            <nav>
                <button onclick="window.location.href='danhSachLopGV.html'">
                    <i class="fas fa-list-ol"></i> <span>Xem danh sách lớp</span>
                </button>

                <button class="active" onclick="window.location.href='nhapDiem.html'">
                    <i class="fas fa-marker"></i> <span>Nhập điểm bộ môn</span>
                </button>

                <button onclick="window.location.href='danhGiaHanhKiem.html'">
                    <i class="fas fa-user-check"></i> <span>Đánh giá hạnh kiểm</span>
                </button>

                <button onclick="window.location.href='tongHopKetQua.html'">
                    <i class="fas fa-chart-line"></i> <span>Tổng hợp kết quả học tập</span>
                </button>

                <button onclick="window.location.href='xemtkbGV.html'">
                    <i class="fas fa-calendar-alt"></i> <span>Xem thời khóa biểu</span>
                </button>

                <button class="logout-btn" onclick="dangXuat()">
                    <i class="fas fa-sign-out-alt"></i> <span>Đăng xuất</span>
                </button>
            </nav>
        </aside>

        <main id="mainContent" class="content">
            
            <div class="card" style="height: 100%; display: flex; flex-direction: column;">
                
                <div class="d-flex align-items-center mb-3 pb-3 border-bottom" style="display: flex; align-items: center; border-bottom: 2px solid #eee; padding-bottom: 15px; margin-bottom: 20px;">
                    <div style="flex: 1;">
                        <i class="fas fa-list-ul" style="margin-right: 10px; color: #555;"></i>
                        <select class="header-select" id="classSelect" onchange="changeClass()">
                            <option value="12A1">Lớp 12A1</option>
                            <option value="12A2">Lớp 12A2</option>
                            <option value="12A3">Lớp 12A3</option>
                        </select>
                    </div>
                    <div style="font-weight: bold; color: #555;">Môn: Toán Học</div>
                </div>

                <div class="table-responsive" style="flex: 1; overflow-y: auto;">
                    <table class="placement-table grade-table" style="width: 100%; border-collapse: separate; border-spacing: 0;">
                        <thead style="position: sticky; top: 0; z-index: 10;">
                            <tr>
                                <th rowspan="2" style="width: 50px;">STT</th>
                                <th rowspan="2" style="min-width: 200px;">Họ tên học sinh</th>
                                <th colspan="3" class="header-hs1">Hệ số 1 (Miệng, 15p)</th>
                                <th colspan="2" class="header-hs2">Hệ số 2 (1 Tiết)</th>
                                <th colspan="1" class="header-hs3">Hệ số 3</th>
                                <th rowspan="2" class="header-dtb" style="width: 80px;">ĐTB</th>
                            </tr>
                            <tr>
                                <td style="width: 60px; background: #fff;">1</td>
                                <td style="width: 60px; background: #fff;">2</td>
                                <td style="width: 60px; background: #fff;">3</td>
                                
                                <td style="width: 60px; background: #fff;">1</td>
                                <td style="width: 60px; background: #fff;">2</td>
                                
                                <td style="width: 60px; background: #fff;">Thi</td>
                            </tr>
                        </thead>
                        <tbody id="gradeTableBody">
                            </tbody>
                    </table>
                </div>

                <div class="bottom-action-bar">
                    <button class="btn-save-grades" onclick="saveGrades()">
                        <i class="fas fa-save me-2"></i> Lưu thay đổi
                    </button>
                </div>

            </div>
        </main>
    </div>

    <script src="thongBao.js"></script>

    <script>
        // 1. MOCK DATA
        const gradeData = {
            "12A1": [
                { id: 1, name: "Phạm Văn Thái Dương", hs1: [8, 9, ""], hs2: [8.5, ""], hs3: "" },
                { id: 2, name: "Nguyễn Doãn Hiếu", hs1: [7, 6.5, 8], hs2: [7.5, 8], hs3: 7.0 },
                { id: 3, name: "Hoàng Văn Hải", hs1: [9, 10, ""], hs2: [9.5, ""], hs3: "" },
                { id: 4, name: "Trần Nguyễn Anh Tài", hs1: [5, 6, 5], hs2: [6.5, 5], hs3: "" },
                { id: 5, name: "Lê Ngọc Phúc", hs1: ["", "", ""], hs2: ["", ""], hs3: "" },
                { id: 6, name: "Nguyễn Văn Hoàng", hs1: [8, 8, 8], hs2: [8, 8], hs3: 8 },
                { id: 7, name: "Nguyễn Đình Bình Minh", hs1: [9, "", ""], hs2: ["", ""], hs3: "" },
                { id: 1, name: "Phạm Văn Thái Dương", hs1: [8, 9, ""], hs2: [8.5, ""], hs3: "" },
                { id: 2, name: "Nguyễn Doãn Hiếu", hs1: [7, 6.5, 8], hs2: [7.5, 8], hs3: 7.0 },
                { id: 3, name: "Hoàng Văn Hải", hs1: [9, 10, ""], hs2: [9.5, ""], hs3: "" },
                { id: 4, name: "Trần Nguyễn Anh Tài", hs1: [5, 6, 5], hs2: [6.5, 5], hs3: "" },
                { id: 5, name: "Lê Ngọc Phúc", hs1: ["", "", ""], hs2: ["", ""], hs3: "" },
                { id: 6, name: "Nguyễn Văn Hoàng", hs1: [8, 8, 8], hs2: [8, 8], hs3: 8 },
                { id: 7, name: "Nguyễn Đình Bình Minh", hs1: [9, "", ""], hs2: ["", ""], hs3: "" },
                { id: 1, name: "Phạm Văn Thái Dương", hs1: [8, 9, ""], hs2: [8.5, ""], hs3: "" },
                { id: 2, name: "Nguyễn Doãn Hiếu", hs1: [7, 6.5, 8], hs2: [7.5, 8], hs3: 7.0 },
                { id: 3, name: "Hoàng Văn Hải", hs1: [9, 10, ""], hs2: [9.5, ""], hs3: "" },
                { id: 4, name: "Trần Nguyễn Anh Tài", hs1: [5, 6, 5], hs2: [6.5, 5], hs3: "" },
                { id: 5, name: "Lê Ngọc Phúc", hs1: ["", "", ""], hs2: ["", ""], hs3: "" },
                { id: 6, name: "Nguyễn Văn Hoàng", hs1: [8, 8, 8], hs2: [8, 8], hs3: 8 },
                { id: 7, name: "Nguyễn Đình Bình Minh", hs1: [9, "", ""], hs2: ["", ""], hs3: "" },
            ],
            "12A2": [
                { id: 101, name: "Học sinh A", hs1: [5, 6, ""], hs2: [5, ""], hs3: "" },
                { id: 102, name: "Học sinh B", hs1: [9, 9, 9], hs2: [9, 9], hs3: 9 }
            ],
            "12A3": []
        };

        let currentClassId = "12A1";

        // 2. HÀM KHỞI TẠO
        function init() {
            // Hiển thị thông tin cán bộ (nếu có hàm từ thongBao.js)
            if(typeof loadUserProfile === 'function') {
                loadUserProfile();
            } else {
                document.getElementById('userName').innerText = "Nguyễn Văn B";
                document.getElementById('userCode').innerText = "MSCB: 456789123JKQ";
            }
            renderTable();
        }

        // 3. RENDER BẢNG
        function renderTable() {
            const tbody = document.getElementById('gradeTableBody');
            tbody.innerHTML = '';
            
            const students = gradeData[currentClassId] || [];

            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding: 20px;">Chưa có danh sách học sinh</td></tr>';
                return;
            }

            students.forEach((st, index) => {
                const tr = document.createElement('tr');
                
                // Tính ĐTB hiện tại
                let avg = calculateAvg(st.hs1, st.hs2, st.hs3);

                tr.innerHTML = `
                    <td style="text-align: center;"><b>${index + 1}</b></td>
                    <td style="text-align: left; padding-left: 10px; font-weight: 600;">${st.name}</td>
                    
                    <td><input type="number" class="grade-input" value="${st.hs1[0]}" oninput="updateScore(${index}, 'hs1', 0, this)"></td>
                    <td><input type="number" class="grade-input" value="${st.hs1[1]}" oninput="updateScore(${index}, 'hs1', 1, this)"></td>
                    <td><input type="number" class="grade-input" value="${st.hs1[2]}" oninput="updateScore(${index}, 'hs1', 2, this)"></td>
                    
                    <td><input type="number" class="grade-input" value="${st.hs2[0]}" oninput="updateScore(${index}, 'hs2', 0, this)"></td>
                    <td><input type="number" class="grade-input" value="${st.hs2[1]}" oninput="updateScore(${index}, 'hs2', 1, this)"></td>
                    
                    <td><input type="number" class="grade-input" value="${st.hs3}" oninput="updateScore(${index}, 'hs3', 0, this)"></td>
                    
                    <td><input type="text" class="grade-input avg-input" id="avg-${index}" value="${avg}" readonly tabindex="-1"></td>
                `;
                tbody.appendChild(tr);
            });
        }

        // 4. LOGIC TÍNH TOÁN
        function updateScore(index, type, colIndex, input) {
            let val = input.value;
            
            // Cập nhật dữ liệu vào biến mockData
            const students = gradeData[currentClassId];
            if (type === 'hs3') {
                students[index][type] = val;
            } else {
                students[index][type][colIndex] = val;
            }

            // Tính lại ĐTB và cập nhật giao diện ngay lập tức
            let newAvg = calculateAvg(students[index].hs1, students[index].hs2, students[index].hs3);
            document.getElementById(`avg-${index}`).value = newAvg;
            
            // Highlight điểm vừa sửa
            input.style.backgroundColor = "#e8f0fe";
        }

        function calculateAvg(hs1, hs2, hs3) {
            let total = 0;
            let count = 0;

            // Cộng HS1
            hs1.forEach(s => { 
                if(s !== "" && s !== null) { 
                    total += parseFloat(s) * 1; 
                    count += 1; 
                } 
            });
            // Cộng HS2
            hs2.forEach(s => { 
                if(s !== "" && s !== null) { 
                    total += parseFloat(s) * 2; 
                    count += 2; 
                } 
            });
            // Cộng HS3
            if(hs3 !== "" && hs3 !== null) { 
                total += parseFloat(hs3) * 3; 
                count += 3; 
            }

            if (count === 0) return "";
            return (total / count).toFixed(1);
        }

        // 5. CÁC HÀM SỰ KIỆN
        function changeClass() {
            const select = document.getElementById('classSelect');
            currentClassId = select.value;
            renderTable();
        }

        function saveGrades() {
            const btn = document.querySelector('.btn-save-grades');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang lưu...';
            btn.disabled = true;

            setTimeout(() => {
                if(typeof showToast === 'function') {
                    showToast(`Đã lưu bảng điểm lớp ${currentClassId} thành công!`, "success");
                } else {
                    alert(`Đã lưu bảng điểm lớp ${currentClassId} thành công!`);
                }
                
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                // Reset màu input
                document.querySelectorAll('.grade-input').forEach(el => el.style.backgroundColor = '');
            }, 800);
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('toggleSidebar');
            if(sidebar) {
                sidebar.classList.toggle('collapsed');
                if (sidebar.classList.contains('collapsed')) {
                    if(toggleBtn) toggleBtn.classList.add('moved');
                } else {
                    if(toggleBtn) toggleBtn.classList.remove('moved');
                }
            }
        }

        // Chạy khi tải trang
        window.onload = init;

    </script>
</body>
</html>