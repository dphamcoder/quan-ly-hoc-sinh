<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tổng hợp kết quả học tập</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <link rel="stylesheet" href="test.css">

    <style>
        /* === QUAN TRỌNG: FIX XUNG ĐỘT GIỮA BOOTSTRAP VÀ LAYOUT CŨ === */
        .container { 
            max-width: 100% !important; 
            padding: 0 !important; 
            margin: 0 !important; 
            height: 100vh; 
        }
        
        body { 
            background: linear-gradient(120deg, #f0f4ff, #e8f7ff); 
            font-family: 'Segoe UI', Tahoma, sans-serif; 
        }

        .table-responsive { 
            overflow-x: auto; 
            max-height: calc(100vh - 250px); 
            border: 1px solid #ccc;
        }
        
        .summary-table thead th { 
            position: sticky; top: 0; z-index: 10; 
            box-shadow: 0 2px 2px rgba(0,0,0,0.1);
        }

        .select-custom {
            font-weight: 700;
            border: 2px solid #6c757d;
            cursor: pointer;
        }
        .select-custom:focus {
            border-color: #4e73df;
            box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
        }
    </style>
</head>
<body class="admin-page">

    <button id="toggleSidebar" class="toggle-btn" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </button>

    <div class="container">
        
        <aside id="sidebar" class="sidebar">
            <div class="teacher-card">
                <div class="avatar"></div>
                <h3 id="userName">Đang tải...</h3> 
                <p id="userCode">...</p>
            </div>

            <nav>
                <button onclick="window.location.href='danhSachLopGV.html'">
                    <i class="fas fa-list-ol"></i> <span>Xem danh sách lớp</span>
                </button>

                <button  onclick="window.location.href='nhapDiem.html'">
                    <i class="fas fa-marker"></i> <span>Nhập điểm bộ môn</span>
                </button>

                <button onclick="window.location.href='danhGiaHanhKiem.html'">
                    <i class="fas fa-user-check"></i> <span>Đánh giá hạnh kiểm</span>
                </button>

                <button class="active" onclick="window.location.href='tongHopKetQua.html'">
                    <i class="fas fa-chart-line"></i> <span>Tổng hợp kết quả học tập</span>
                </button>

                <button onclick="window.location.href='xemtkbGV.html'">
                    <i class="fas fa-calendar-alt"></i> <span>Xem thời khóa biểu</span>
                </button>

                <button class="logout-btn" onclick="dangXuat()">
                    <i class="fas fa-sign-out-alt"></i> <span>Đăng xuất</span>
                </button>
            </nav>
        </aside>

        <main id="mainContent" class="content">
            
            <div class="report-controls">
                <div class="d-flex align-items-center gap-2">
                    <label class="fw-bold text-secondary text-nowrap">Lớp:</label>
                    <select class="form-select select-custom w-auto" id="classSelect" onchange="renderReport()">
                        <option value="12A1">Lớp 12A1</option>
                        <option value="12A2">Lớp 12A2</option>
                        <option value="11B1">Lớp 11B1</option>
                    </select>
                </div>
                
                <div class="fw-bold text-primary text-uppercase fs-5 d-none d-md-block">
                    <i class="fas fa-file-alt me-2"></i> Bảng Tổng Hợp Kết Quả
                </div>
                
                <div class="d-flex align-items-center gap-2">
                    <select class="form-select select-custom bg-warning-subtle text-dark border-warning" aria-label="Chọn học kỳ">
                        <option value="1" selected>Học kỳ 1</option>
                        <option value="2">Học kỳ 2</option>
                        <option value="all">Cả năm</option>
                    </select>

                    <select class="form-select select-custom" aria-label="Chọn năm học">
                        <option value="2025-2026" selected>2025-2026</option>
                        <option value="2024-2025">2024-2025</option>
                        <option value="2023-2024">2023-2024</option>
                    </select>
                </div>
            </div>

            <div class="card" style="border: none; padding: 0; overflow: hidden;">
                <div class="table-responsive">
                    <table class="table table-bordered table-hover summary-table mb-0">
                        <thead>
                            <tr>
                                <th class="col-stt">STT</th>
                                <th class="col-name">Họ và Tên Học Sinh</th>
                                <th style="width: 50px;">Toán</th>
                                <th style="width: 50px;">Văn</th>
                                <th style="width: 50px;">Anh</th>
                                <th style="width: 50px;">Lý</th>
                                <th style="width: 50px;">Hóa</th>
                                <th style="width: 50px;">Sinh</th>
                                <th style="width: 50px;">Sử</th>
                                <th style="width: 50px;">Địa</th>
                                <th style="width: 50px;">GDCD</th>
                                <th style="width: 50px;">Tin</th>
                                <th style="width: 50px;">CN</th>
                                <th style="width: 50px;">TD</th>
                                <th style="width: 50px;">GDQP</th>
                                <th style="width: 60px; background: #fff3cd !important;">ĐTB</th>
                                <th style="width: 80px; background: #d1e7dd !important;">Hạnh Kiểm</th>
                                <th style="width: 80px; background: #cfe2ff !important;">Danh Hiệu</th>
                            </tr>
                        </thead>
                        <tbody id="reportBody">
                            </tbody>
                    </table>
                </div>

                <div class="bottom-actions bg-white border-top">
                    <button class="btn btn-print" onclick="window.print()">
                        <i class="fas fa-print me-2"></i> In Bảng Điểm
                    </button>
                    <button class="btn btn-print" style="background: #1cc88a; color: white; border: none;">
                        <i class="fas fa-file-excel me-2"></i> Xuất Excel
                    </button>
                </div>
            </div>

        </main>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="thongBao.js"></script>

    <script>
        // 1. Dữ liệu giả lập MOCK
        const mockReportData = [
            { name: "Phạm Văn Thái Dương", hk: "Tốt", scores: [8.5, 7.0, 9.0, 8.2, 8.8, 7.5, 8.0, 9.0, 9.5, 10.0, 8.5, "Đ", "Đ"] },
            { name: "Nguyễn Doãn Hiếu", hk: "Khá", scores: [7.0, 6.5, 7.5, 6.8, 7.0, 6.5, 8.0, 7.5, 8.0, 9.0, 8.0, "Đ", "Đ"] },
            { name: "Hoàng Văn Hải", hk: "Tốt", scores: [9.0, 8.5, 9.5, 9.2, 9.8, 8.5, 8.0, 9.0, 9.5, 9.0, 9.0, "Đ", "Đ"] },
            { name: "Trần Nguyễn Anh Tài", hk: "TB", scores: [5.0, 6.0, 5.5, 5.8, 6.0, 5.5, 7.0, 6.5, 7.5, 8.0, 7.0, "Đ", "CĐ"] },
            { name: "Lê Ngọc Phúc", hk: "Khá", scores: [6.5, 7.0, 6.5, 6.0, 8.0, 7.0, 6.5, 7.5, 6.0, 7.0, 7.5, "Đ", "Đ"] },
            { name: "Nguyễn Văn Hoàng", hk: "Tốt", scores: [8.0, 8.0, 8.0, 8.0, 8.0, 8.0, 8.0, 8.0, 8.0, 8.0, 8.0, "Đ", "Đ"] },
            { name: "Nguyễn Đình Bình Minh", hk: "Tốt", scores: [9.0, 8.5, 9.0, 8.8, 9.0, 8.5, 9.0, 9.0, 9.5, 9.5, 9.0, "Đ", "Đ"] },
            { name: "", hk: "", scores: [] },
            { name: "", hk: "", scores: [] },
            { name: "", hk: "", scores: [] }
        ];

        // 2. Hàm Tính ĐTB
        function calculateFinalAvg(scores) {
            if (!scores || scores.length === 0) return "";
            let sum = 0;
            let count = 0;
            scores.forEach(s => {
                if (typeof s === 'number') {
                    sum += s;
                    count++;
                }
            });
            return count > 0 ? (sum / count).toFixed(1) : "";
        }

        // 3. Hàm Xếp loại
        function getRank(avg, hk) {
            if (avg === "" || !hk) return "";
            if (avg >= 8.0 && hk === "Tốt") return "HS Giỏi";
            if (avg >= 6.5 && (hk === "Tốt" || hk === "Khá")) return "HS Tiên Tiến";
            return "";
        }

        // 4. Render Bảng
        function renderReport() {
            const tbody = document.getElementById('reportBody');
            tbody.innerHTML = '';

            mockReportData.forEach((st, index) => {
                const tr = document.createElement('tr');
                if (!st.name) {
                    tr.innerHTML = `
                        <td class="col-stt"></td>
                        <td><input type="text" class="cell-score" readonly></td>
                        ${Array(13).fill('<td></td>').join('')}
                        <td></td><td></td><td></td>
                    `;
                } else {
                    let scoreCells = st.scores.map(s => {
                        let colorStyle = "";
                        if (typeof s === 'number' && s < 5.0) colorStyle = "color: red; font-weight: bold;";
                        return `<td><input type="text" class="cell-score" value="${s}" readonly style="${colorStyle}"></td>`;
                    }).join('');

                    const finalAvg = calculateFinalAvg(st.scores);
                    const rank = getRank(finalAvg, st.hk);
                    
                    let avgStyle = "";
                    if(finalAvg >= 8.0) avgStyle = "color: #1cc88a; font-weight: 800;";
                    else if(finalAvg < 5.0 && finalAvg !== "") avgStyle = "color: #e74a3b; font-weight: 800;";

                    let rankBadge = "";
                    if (rank === "HS Giỏi") rankBadge = `<span class="badge bg-danger">Giỏi</span>`;
                    else if (rank === "HS Tiên Tiến") rankBadge = `<span class="badge bg-primary">Tiên Tiến</span>`;

                    tr.innerHTML = `
                        <td class="col-stt">${index + 1}</td>
                        <td class="col-name text-start ps-2">${st.name}</td>
                        ${scoreCells}
                        <td style="background: #fff3cd;"><input type="text" class="cell-score" value="${finalAvg}" readonly style="${avgStyle}"></td>
                        <td>${st.hk}</td>
                        <td>${rankBadge}</td>
                    `;
                }
                tbody.appendChild(tr);
            });
        }

        // 5. Sidebar Toggle (Giữ lại để phòng trường hợp thongBao.js chưa load kịp)
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const toggleBtn = document.getElementById('toggleSidebar');
            if (sidebar) {
                sidebar.classList.toggle('collapsed');
                if (sidebar.classList.contains('collapsed')) {
                    if (toggleBtn) toggleBtn.classList.add('moved');
                } else {
                    if (toggleBtn) toggleBtn.classList.remove('moved');
                }
            }
        }

        window.onload = function() {
            renderReport();
            // Nếu file thongBao.js đã load xong, gọi hàm này để điền tên
            if(typeof loadUserProfile === 'function') loadUserProfile();
        };
    </script>
</body>
</html>